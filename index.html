import { useState, useEffect, useCallback } from 'react';
import { Dashboard } from './components/Dashboard';
import { CommandConsole } from './components/CommandConsole';
import { EffectSelector } from './components/EffectSelector';
import { TimerPanel } from './components/TimerPanel';
import { SettingsPanel } from './components/SettingsPanel';
import { StatusIndicators } from './components/StatusIndicators';
import { RGBControls } from './components/RGBControls';
import { SceneButtons } from './components/SceneButtons';
import { effectsDatabase } from './data/effects';
import { executeCommand } from './utils/commandProcessor';
import type { SystemState, TimerState, WiFiStatus } from './types';

export default function App() {
  const [systemState, setSystemState] = useState<SystemState>({
    power: false,
    red: 0,
    green: 0,
    blue: 0,
    brightness: 100,
    currentEffect: 0,
    manualSetMode: 0,
    lastCommand: '',
    uptime: 0,
    freeMemory: 45000
  });

  const [timerState, setTimerState] = useState<TimerState>({
    active: false,
    totalSeconds: 0,
    remainingSeconds: 0,
    pendingCommand: ''
  });

  const [wifiStatus, setWifiStatus] = useState<WiFiStatus>({
    mode: 'connected',
    ssid: 'Home_Network',
    apPassword: 'mainak@2009',
    rssi: -65
  });

  const [activeTab, setActiveTab] = useState<'dashboard' | 'console' | 'effects' | 'settings'>('dashboard');
  const [consoleHistory, setConsoleHistory] = useState<Array<{ type: 'command' | 'response' | 'error'; text: string }>>([
    { type: 'response', text: 'Smart RGB Lighting OS v2.1' },
    { type: 'response', text: 'Type /help for commands' }
  ]);

  // Simulate uptime counter
  useEffect(() => {
    const interval = setInterval(() => {
      setSystemState(prev => ({ ...prev, uptime: prev.uptime + 1 }));
    }, 1000);
    return () => clearInterval(interval);
  }, []);

  // Timer countdown
  useEffect(() => {
    if (!timerState.active || timerState.remainingSeconds <= 0) return;

    const interval = setInterval(() => {
      setTimerState(prev => {
        const newRemaining = prev.remainingSeconds - 1;
        
        if (newRemaining <= 0) {
          // Execute pending command when timer reaches 0
          if (prev.pendingCommand) {
            handleCommandExecute(prev.pendingCommand);
          }
          return {
            active: false,
            totalSeconds: 0,
            remainingSeconds: 0,
            pendingCommand: ''
          };
        }
        
        return { ...prev, remainingSeconds: newRemaining };
      });
    }, 1000);

    return () => clearInterval(interval);
  }, [timerState.active, timerState.remainingSeconds]);

  const handleCommandExecute = useCallback((command: string) => {
    const result = executeCommand(
      command,
      systemState,
      timerState,
      wifiStatus,
      effectsDatabase,
      (newState) => setSystemState(prev => ({ ...prev, ...newState })),
      (newTimer) => setTimerState(prev => ({ ...prev, ...newTimer })),
      (newWifi) => setWifiStatus(prev => ({ ...prev, ...newWifi }))
    );

    setConsoleHistory(prev => [
      ...prev,
      { type: 'command', text: command },
      { type: result.success ? 'response' : 'error', text: result.message }
    ]);

    setSystemState(prev => ({ ...prev, lastCommand: command }));
  }, [systemState, timerState, wifiStatus]);

  const handleRGBChange = (r: number, g: number, b: number) => {
    setSystemState(prev => ({ ...prev, red: r, green: g, blue: b, currentEffect: 0 }));
  };

  const handleBrightnessChange = (brightness: number) => {
    setSystemState(prev => ({ ...prev, brightness }));
  };

  const handleEffectSelect = (effectId: number) => {
    setSystemState(prev => ({ ...prev, currentEffect: effectId, power: true }));
  };

  const formatUptime = (seconds: number): string => {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (days > 0) return `${days}d ${hours}h ${mins}m`;
    if (hours > 0) return `${hours}h ${mins}m ${secs}s`;
    if (mins > 0) return `${mins}m ${secs}s`;
    return `${secs}s`;
  };

  return (
    <div className="min-h-screen bg-gray-950 text-gray-100">
      {/* Header */}
      <header className="bg-gray-900 border-b border-gray-800 sticky top-0 z-50">
        <div className="container mx-auto px-4 py-3">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-xl font-mono font-semibold">RGB Lighting OS</h1>
              <p className="text-xs text-gray-500 font-mono">ESP8266 v2.1</p>
            </div>
            <StatusIndicators 
              wifiStatus={wifiStatus}
              power={systemState.power}
              effectActive={systemState.currentEffect > 0}
            />
          </div>
          
          {/* System Info Bar */}
          <div className="mt-3 flex items-center gap-4 text-xs font-mono text-gray-500">
            <span>UP: {formatUptime(systemState.uptime)}</span>
            <span>MEM: {Math.floor(systemState.freeMemory / 1024)}KB</span>
            <span>RSSI: {wifiStatus.rssi}dBm</span>
          </div>
        </div>
      </header>

      {/* Tab Navigation */}
      <nav className="bg-gray-900 border-b border-gray-800 sticky top-[88px] z-40">
        <div className="container mx-auto px-4">
          <div className="flex gap-1">
            {(['dashboard', 'console', 'effects', 'settings'] as const).map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-4 py-2 text-sm font-mono capitalize transition-colors ${
                  activeTab === tab
                    ? 'bg-blue-600 text-white'
                    : 'text-gray-400 hover:text-gray-200 hover:bg-gray-800'
                }`}
              >
                {tab}
              </button>
            ))}
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="container mx-auto px-4 py-6 pb-24">
        {activeTab === 'dashboard' && (
          <Dashboard
            systemState={systemState}
            timerState={timerState}
            onRGBChange={handleRGBChange}
            onBrightnessChange={handleBrightnessChange}
            onCommandExecute={handleCommandExecute}
          />
        )}

        {activeTab === 'console' && (
          <CommandConsole
            history={consoleHistory}
            onCommandExecute={handleCommandExecute}
          />
        )}

        {activeTab === 'effects' && (
          <EffectSelector
            effects={effectsDatabase}
            currentEffect={systemState.currentEffect}
            onEffectSelect={handleEffectSelect}
          />
        )}

        {activeTab === 'settings' && (
          <SettingsPanel
            wifiStatus={wifiStatus}
            systemState={systemState}
            onWifiUpdate={(updates) => setWifiStatus(prev => ({ ...prev, ...updates }))}
            onRestart={() => {
              handleCommandExecute('/restart');
              setTimeout(() => window.location.reload(), 2000);
            }}
          />
        )}
      </main>

      {/* Quick Actions Footer */}
      <footer className="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 p-4">
        <SceneButtons onSceneSelect={(scene) => handleCommandExecute(`/scene ${scene}`)} />
      </footer>
    </div>
  );
}
            
